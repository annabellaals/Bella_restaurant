{% extends 'home/base.html' %}
{% load static %}

{% block content %}
    <body class="sub_page">
    <div class="hero_area">
        <div class="bg-box">
            <img src="{% static 'images/hero-bg.jpg' %}" alt="">
        </div>
        {% include 'home/partials/_header.html' %}
    </div>

    <script>
        function getItems() {
            const items = JSON.parse(localStorage.getItem('bella_cart')) || [];
            displayItems(items)
        }

        function deleteItems(id) {
            console.log(id)
            let array = JSON.parse(localStorage.getItem('bella_cart')) || [];
            const index = array.findIndex(item => item.id === id);
            if (index !== -1) {
                array.splice(index, 1);
            }
            localStorage.setItem('bella_cart', JSON.stringify(array));
            displayItems(array)
        }

        function displayItems(items) {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            let total_price = 0
            items.forEach(item => {
                const itemDiv = ` <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex flex-row align-items-center">
                                    <div>
                                        <img
                                                src="${item.image_url}"
                                                class="img-fluid rounded-3" alt="Shopping item" style="width: 65px;">
                                    </div>
                                    <div class="ms-3" style="margin-left: 20px">
                                        <h5>${item.name}</h5>
                                        <p class="small mb-0">${item.description}</p>
                                    </div>
                                </div>
                                <div class="d-flex flex-row align-items-center">
                                    <div style="width: 50px;">
                                        <h5 class="fw-normal mb-0">1</h5>
                                    </div>
                                    <div style="width: 80px;">
                                        <h5 class="mb-0">$ ${item.price}.00</h5>
                                    </div>
                                    <span style="color: #cecece;margin-left: 20px;cursor: pointer" onclick='deleteItems("${item.id}")'><i class="fa-solid fa-xmark"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>`
                container.innerHTML += itemDiv;
                total_price += item.price
            });
            const elements = document.querySelectorAll('.total_price_display');
            elements.forEach(element => {
                element.innerText = `$${total_price}.00`
            });
        }

        function place_order(is_authenticated) {
            if (is_authenticated === "False")
                window.location.href = "/login?next=/cart"
            const array = JSON.parse(localStorage.getItem("bella_cart")) || [];
            if (array.length === 0)
                return

            const ids = array.map(item => item.id);
            $.ajax({
                headers: {"X-CSRFToken": getCookie("csrftoken")},
                type: "POST",
                url: '{% url 'place_order' %}',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify({
                    item_ids: ids,
                }),
                success: function (data) {
                    localStorage.setItem('bella_cart', JSON.stringify([]));
                    window.location.href = data.redirect
                },
                failure: function (data) {
                    console.log(data)
                }
            });
        }

        window.onload = getItems;
    </script>

    <section class="book_section layout_padding">
        <div class="container">
            <div class="row">
                <div id="itemsContainer" class="col-lg-7">
                </div>
                <div class="col-lg-5">

                    <div class="card bg-primary text-white rounded-3">
                        <div class="card-body my-3">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-2">Order details</h5>
                            </div>
                            <hr class="my-6">
                            <div class="d-flex justify-content-between">
                                <p class="mb-2">Subtotal</p>
                                <p class="total_price_display mb-2">$0.00</p>
                            </div>
                            <div class="d-flex justify-content-between">
                                <p class="mb-2">delivery</p>
                                <p class="mb-2">$0.00</p>
                            </div>
                            <div class="d-flex justify-content-between mb-4">
                                <p class="mb-2">Total(Incl. taxes)</p>
                                <p class="total_price_display mb-2">$0.00</p>
                            </div>
                            <button onclick="place_order(`{{ is_authenticated }}`)" type="button" data-mdb-button-init data-mdb-ripple-init
                                    class="btn btn-info btn-block btn-lg">
                                <div class="d-flex justify-content-between">
                                    <span class="total_price_display">$0.00</span>
                                    <span>Place Order <i class="fas fa-long-arrow-alt-right ms-2"></i></span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% include 'home/partials/_footer.html' %}
{% endblock %}
